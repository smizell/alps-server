#!/usr/bin/env node

var alpsFromXml = require('minim-alps').alpsFromXml;
var alpsToHtml = require('minim-alps').alpsToHtml;
var async = require('async');
var fs = require('fs');
var path = require('path');

// The URL appended to all HREFs in profiles
// This replaces http://alps.io
// TODO: Pull from configuration file
var appendUrl = process.argv[2] || '';

// Directory of ALPs profiles
var profilesDir = path.resolve(__dirname, '..', 'profiles');

// Process files
async.waterfall([
  readProfilesDir,
  transformFiles
], function (errors) {
  if (errors) {
    console.log(errors);
  }
});

// ----------------------------------------------------------------------------

function readProfilesDir(callback) {
  fs.readdir(profilesDir, callback);
}

function transformFiles(files, callback) {
  async.each(files, function(filename, eachCallback) {
    var fileHandler = transformFile(filename, eachCallback);
    fs.readFile(path.resolve(profilesDir, filename), 'utf8', fileHandler);
  }, callback);
}

function transformFile(filename, callback) {
  return function(error, originalXml) {
    if (error) {
      return callback(error);
    }

    async.waterfall([
      function(next) {
        transformXml(filename, originalXml, next);
      },
      function(newXml, next) {
        transformRefract(filename, newXml, next);
      },
      function(refract, next) {
        transformHtml(filename, refract, next);
      }
    ], callback)
  }
}

function transformXml(originalFilename, originalXml, callback) {
  var newXml = originalXml.replace(/http:\/\/alps.io/g, appendUrl);
  var newFilename = path.resolve(profilesDir, originalFilename.replace('.xml', '-final.xml'));

  fs.writeFile(newFilename, newXml, function(error) {
    if (error) {
      return callback(error);
    }

    callback(null, newXml);
  });
}

function transformRefract(originalFilename, newXml, callback) {
  var refract = alpsFromXml(newXml);
  var newFilename = path.resolve(profilesDir, originalFilename.replace('.xml', '-refract-final.json'));
  var refractJson = JSON.stringify(refract.toRefract(), null, 2);

  fs.writeFile(newFilename, refractJson, function(error) {
    if (error) {
      return callback(error);
    }

    callback(null, refract);
  });
}

function transformHtml(originalFilename, refract, callback) {
  var html = alpsToHtml(refract);
  var newFilename = path.resolve(profilesDir, originalFilename.replace('.xml', '-final.html'));

  fs.writeFile(newFilename, html, function(error) {
    if (error) {
      return callback(error);
    }
    
    callback(null, html);
  });
}
